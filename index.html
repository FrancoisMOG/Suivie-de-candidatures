<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi Candidatures - GRETA</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #000091;
            --accent: #e1000f;
            --bg: #f6f6f6;
            --white: #ffffff;
            --border: #e5e5e5;
            --status-ok: #22c55e;
            --status-no: #ef4444;
            --status-wait: #f59e0b;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: var(--bg);
            color: #161616;
            margin: 0;
            padding: 20px;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--white);
            padding: 15px 25px;
            border-radius: 8px;
            margin-bottom: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .logo-container img { height: 80px; width: auto; }
        .header-title h1 { margin: 0; font-size: 1.2rem; color: var(--primary); }

        .card {
            background: var(--white);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }

        .user-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px dashed var(--border);
        }

        .grid-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .form-group { display: flex; flex-direction: column; }
        label { font-size: 0.8rem; font-weight: 700; margin-bottom: 6px; color: #3a3a3a; }
        input, select { padding: 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 0.9rem; }

        .btn-group { display: flex; gap: 15px; margin-top: 20px; }
        button { padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .btn-add { background: var(--primary); color: white; flex-grow: 1; }
        .btn-excel { background: #1f7244; color: white; display: flex; align-items: center; gap: 8px; }

        .table-container {
            background: var(--white);
            border-radius: 8px;
            overflow-x: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        table { width: 100%; border-collapse: collapse; min-width: 1100px; }
        th { background: #f0f0f0; color: #161616; font-size: 0.8rem; padding: 15px; text-align: left; border-bottom: 2px solid var(--border); }
        td { padding: 12px 15px; border-bottom: 1px solid var(--bg); font-size: 0.9rem; }
        
        .badge-etape { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; background: #e3e3fd; color: #000091; font-weight: bold; }

        .res-vert { color: var(--status-ok); font-weight: bold; }
        .res-rouge { color: var(--status-no); font-weight: bold; }
        .res-orange { color: var(--status-wait); font-weight: bold; }

        .btn-del { color: var(--accent); background: none; border: 1px solid var(--accent); padding: 5px 10px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="logo-container">
            <img src="Logo-GRETA-Lille-Metropole-500.png" alt="Logo GRETA Lille M√©tropole">
        </div>
        <div class="header-title">
            <h1>Suivi d'Activit√© Recherche de Stage</h1>
        </div>
        <button class="btn-excel" onclick="exportToExcel()">üìä Export Excel (Paysage)</button>
    </header>

    <div class="card">
        <form id="jobForm">
            <div class="user-info">
                <div class="form-group">
                    <label>NOM</label>
                    <input type="text" id="userNom" placeholder="Votre nom" required oninput="saveProfile()">
                </div>
                <div class="form-group">
                    <label>PR√âNOM</label>
                    <input type="text" id="userPrenom" placeholder="Votre pr√©nom" required oninput="saveProfile()">
                </div>
            </div>

            <div class="grid-form">
                <div class="form-group"><label>Date</label><input type="date" id="date" required></div>
                <div class="form-group">
                    <label>Contact</label>
                    <select id="etapeContact">
                        <option value="1er contact">1er contact</option>
                        <option value="Relance 1">Relance 1</option>
                        <option value="Relance 2">Relance 2</option>
                        <option value="Relance 3">Relance 3</option>
                    </select>
                </div>
                <div class="form-group"><label>Entreprise</label><input type="text" id="entreprise" required></div>
                <div class="form-group"><label>Ville</label><input type="text" id="ville"></div>
                <div class="form-group"><label>Email</label><input type="email" id="email"></div>
                <div class="form-group"><label>T√©l√©phone</label><input type="tel" id="tel"></div>
                <div class="form-group">
                    <label>Mode de contact</label>
                    <select id="typeContact">
                        <option value="Mail">Mail</option>
                        <option value="T√©l√©phone">T√©l√©phone</option>
                        <option value="En personne">En personne</option>
                    </select>
                </div>
                <div class="form-group"><label>Interlocuteur</label><input type="text" id="contactNom"></div>
                <div class="form-group">
                    <label>Documents d√©pos√©s</label>
                    <select id="document">
                        <option value="CV">CV</option>
                        <option value="CV + email de motivation">CV + email de motivation</option>
                        <option value="CV + Lettre de motivation">CV + Lettre de motivation</option>
                        <option value="CV + Mail de motivation + Lettre de motivation">CV + Mail de motivation + Lettre de motivation</option>
                    </select>
                </div>
                <div class="form-group"><label>R√©ponse / R√©sultat</label><input type="text" id="reponse"></div>
            </div>
            <div class="btn-group">
                <button type="submit" class="btn-add">Enregistrer cette action</button>
            </div>
        </form>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Date</th><th>√âtape</th><th>Entreprise</th><th>Ville</th><th>Email</th><th>T√©l√©phone</th><th>Via</th><th>Contact</th><th>Documents</th><th>R√©ponse</th><th></th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    // --- LIGNE DE NETTOYAGE ABSOLU ---
    // Cette commande vide toute la m√©moire du navigateur li√©e √† ce document au chargement.
    if (!sessionStorage.getItem('cleaned')) {
        localStorage.clear();
        sessionStorage.setItem('cleaned', 'true');
    }

    const jobForm = document.getElementById('jobForm');
    const tableBody = document.getElementById('tableBody');

    function saveProfile() {
        localStorage.setItem('greta_nom', document.getElementById('userNom').value);
        localStorage.setItem('greta_prenom', document.getElementById('userPrenom').value);
    }

    function loadProfile() {
        if(localStorage.getItem('greta_nom')) document.getElementById('userNom').value = localStorage.getItem('greta_nom');
        if(localStorage.getItem('greta_prenom')) document.getElementById('userPrenom').value = localStorage.getItem('greta_prenom');
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadProfile();
        displayJobs();
    });

    function getResponseClass(text) {
        if (!text) return 'res-orange';
        const cleanText = text.trim().toLowerCase();
        if (['oui', 'ok'].includes(cleanText)) return 'res-vert';
        if (['non'].includes(cleanText)) return 'res-rouge';
        return 'res-orange';
    }

    jobForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const job = {
            id: Date.now(),
            userNom: document.getElementById('userNom').value,
            userPrenom: document.getElementById('userPrenom').value,
            date: document.getElementById('date').value,
            etape: document.getElementById('etapeContact').value,
            entreprise: document.getElementById('entreprise').value,
            ville: document.getElementById('ville').value,
            email: document.getElementById('email').value,
            tel: document.getElementById('tel').value,
            type: document.getElementById('typeContact').value,
            contactNom: document.getElementById('contactNom').value,
            document: document.getElementById('document').value,
            reponse: document.getElementById('reponse').value
        };

        let jobs = JSON.parse(localStorage.getItem('gretaCandidatures') || '[]');
        jobs.push(job);
        localStorage.setItem('gretaCandidatures', JSON.stringify(jobs));
        
        jobForm.reset();
        loadProfile();
        displayJobs();
    });

    function displayJobs() {
        let jobs = JSON.parse(localStorage.getItem('gretaCandidatures') || '[]');
        jobs.sort((a, b) => new Date(b.date) - new Date(a.date));
        tableBody.innerHTML = jobs.map(job => `
            <tr>
                <td>${new Date(job.date).toLocaleDateString('fr-FR')}</td>
                <td><span class="badge-etape">${job.etape}</span></td>
                <td><strong>${job.entreprise}</strong></td>
                <td>${job.ville}</td>
                <td><small>${job.email}</small></td>
                <td><small>${job.tel}</small></td>
                <td>${job.type}</td>
                <td>${job.contactNom}</td>
                <td>${job.document}</td>
                <td class="${getResponseClass(job.reponse)}">${job.reponse}</td>
                <td><button class="btn-del" onclick="deleteJob(${job.id})">X</button></td>
            </tr>
        `).join('');
    }

    function deleteJob(id) {
        if(confirm("Supprimer ?")) {
            let jobs = JSON.parse(localStorage.getItem('gretaCandidatures')).filter(j => j.id !== id);
            localStorage.setItem('gretaCandidatures', JSON.stringify(jobs));
            displayJobs();
        }
    }

    function exportToExcel() {
        let jobs = JSON.parse(localStorage.getItem('gretaCandidatures') || '[]');
        if(jobs.length === 0) return alert("Aucune donn√©e.");
        const data = jobs.map(j => ({
            "NOM": j.userNom, "PR√âNOM": j.userPrenom, "Date": j.date, "√âtape": j.etape, "Entreprise": j.entreprise, 
            "Ville": j.ville, "Email": j.email, "T√©l": j.tel, "Contact": j.type, "Interlocuteur": j.contactNom, 
            "Documents": j.document, "R√©ponse": j.reponse
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Suivi");
        XLSX.writeFile(wb, "Suivi_Stage.xlsx");
    }
</script>
</body>
</html>
